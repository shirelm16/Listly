<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:model="clr-namespace:Listly.Model"
             x:Class="Listly.View.ShoppingListDetailsPage"
             xmlns:viewmodel="clr-namespace:Listly.ViewModel"
             x:DataType="viewmodel:ShoppingListDetailsViewModel"
             xmlns:converters="clr-namespace:Listly.Converters"
             xmlns:selectors="clr-namespace:Listly.Selectors"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             BackgroundColor="{StaticResource Background}"
             x:Name="Page">
    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header with List Name -->
        <Border Grid.Row="0" 
                BackgroundColor="{StaticResource Surface}"
                StrokeThickness="0">
            <Border.Shadow>
                <Shadow Brush="Black" Opacity="0.08" Radius="8" Offset="0,2"/>
            </Border.Shadow>

            <Grid ColumnDefinitions="Auto,*,Auto" Padding="10,15,20,15" ColumnSpacing="10">
                <ContentView Grid.Column="0" WidthRequest="20" HeightRequest="20" VerticalOptions="Center">
                    <Image Source="back_33dp.svg"
                           VerticalOptions="Center"
                           HorizontalOptions="Start"
                           Aspect="AspectFit">
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding BackCommand}" />
                        </Image.GestureRecognizers>
                    </Image>
                </ContentView>
                <Label Grid.Column="1" 
                       Text="{Binding ShoppingList.Name}"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="{StaticResource OnSurface}"
                       VerticalOptions="Center"
                       HorizontalOptions="Start"/>

                <ContentView Grid.Column="2" WidthRequest="20" HeightRequest="20" VerticalOptions="Center">
                    <Image Source="dots.png"
                           VerticalOptions="Center"
                           HorizontalOptions="End"
                           Aspect="AspectFit">
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ShowMoreMenuCommand}" />
                        </Image.GestureRecognizers>
                    </Image>
                </ContentView>
            </Grid>
        </Border>
        <CollectionView Grid.Row="1"
                        IsGrouped="True"
                        ItemsSource="{Binding GroupedItems}"
                        ItemTemplate="{StaticResource ShoppingItemTemplate}">
            <CollectionView.GroupHeaderTemplate>
                <selectors:ShoppingGroupHeaderTemplateSelector  ExpandableHeaderTemplate="{StaticResource ExpandableHeaderTemplate}"
                                                                EmptyHeaderTemplate="{StaticResource EmptyHeaderTemplate}"/>
            </CollectionView.GroupHeaderTemplate>
        </CollectionView>

        <Frame Grid.Row="1"
               x:Name="UndoToast"
               BackgroundColor="{StaticResource OnSurface}"
               BorderColor="Transparent"
               CornerRadius="25"
               Padding="16,12"
               Margin="20"
               IsVisible="{Binding ShowUndoToast}"
               VerticalOptions="End"
               HorizontalOptions="Center"
               ZIndex="100">
            <Frame.Shadow>
                <Shadow Brush="Black" Opacity="0.2" Radius="8" Offset="0,4"/>
            </Frame.Shadow>
            <StackLayout Orientation="Horizontal" Spacing="12">
                <Label x:Name="UndoMessage"
                        Text="Item marked as purchased"
                        TextColor="{StaticResource Surface}"
                        FontSize="14"
                        VerticalOptions="Center"/>
                <Button x:Name="UndoButton"
                        Text="UNDO"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"
                        FontSize="14"
                        FontAttributes="Bold"
                        Padding="8,0"
                        Command="{Binding UndoLastPurchaseCommand}"/>
            </StackLayout>
        </Frame>
        <Button Grid.Row="2"
                Text="+ Add Item"
                BackgroundColor="{StaticResource Primary}"
                TextColor="{StaticResource OnPrimary}"
                Margin="20"
                Padding="20,16"
                CornerRadius="25"
                FontSize="16"
                FontAttributes="Bold"
                Command="{Binding AddItemCommand}"
                IsVisible="{Binding IsNormalMode}">
            <Button.Shadow>
                <Shadow Brush="{StaticResource Primary}" Opacity="0.3" Radius="12" Offset="0,4"/>
            </Button.Shadow>
        </Button>
        <Frame Grid.Row="2"
            BackgroundColor="{StaticResource Primary}"
            BorderColor="Transparent"
            CornerRadius="28"
            Padding="20,16"
            Margin="16,8,16,16"
            HasShadow="True"
            IsVisible="{Binding IsSelectionMode}">
            <Frame.Shadow>
                <Shadow Brush="Black" Opacity="0.3" Radius="12" Offset="0,4"/>
            </Frame.Shadow>
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="16">
                <Label Grid.Column="0"
                    Text="{Binding SelectionText}"
                    TextColor="{StaticResource OnPrimary}"
                    FontSize="16"
                    FontAttributes="Bold"
                    VerticalOptions="Center"/>
                <Button Grid.Column="1"
                    Text="Delete"
                    FontSize="16"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource OnPrimary}"
                    WidthRequest="50"
                    HeightRequest="50"
                    CornerRadius="25"
                    Padding="0"
                    Command="{Binding DeleteSelectedCommand}"/>
                <Button Grid.Column="2"
                    Text="✕"
                    FontSize="20"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource OnPrimary}"
                    WidthRequest="50"
                    HeightRequest="50"
                    CornerRadius="25"
                    Padding="0"
                    Command="{Binding CancelSelectionCommand}"/>
            </Grid>
        </Frame>
    </Grid>
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StrikeThroughIfPurchasedConverter x:Key="StrikeThroughIfPurchasedConverter" />
            <converters:NullOrEmptyToBoolConverter x:Key="NullOrEmptyToBoolConverter" />
            <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
            <converters:BoolToExpandIconConverter x:Key="BoolToExpandIconConverter" />
            <converters:CategoryToIconConverter x:Key="CategoryToIconConverter" />
            <converters:PriorityToIconConverter x:Key="PriorityToIconConverter" />
            <converters:ItemSelectedToColorConverter x:Key="ItemSelectedToColorConverter" />
            <DataTemplate x:Key="ShoppingItemTemplate" x:DataType="model:ShoppingItem">
                <Border StrokeThickness="0"
                        Margin="0,6"
                        Padding="16"
                        StrokeShape="RoundRectangle 12">
                    <Border.BackgroundColor>
                        <MultiBinding Converter="{StaticResource ItemSelectedToColorConverter}">
                            <Binding Source="{x:Reference Page}" Path="BindingContext.SelectedItemIds"/>
                            <Binding Path="Id"/>
                        </MultiBinding>
                    </Border.BackgroundColor>
                    <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                        <CheckBox Grid.Column="0"
                                  Color="{StaticResource Primary}"
                                  IsChecked="{Binding IsPurchased, Mode=TwoWay}"
                                  VerticalOptions="Center"/>
                        <Grid x:Name="ItemGrid" Grid.Column="1" ColumnDefinitions="Auto,*">
                            <Grid.Behaviors>
                                <toolkit:TouchBehavior LongPressCommand="{Binding Source={x:Reference Page}, Path=BindingContext.ItemLongPressCommand}"
                                                   LongPressCommandParameter="{Binding Source={x:Reference ItemGrid}, Path=BindingContext}"
                                                   Command="{Binding Source={x:Reference Page}, Path=BindingContext.ItemTappedCommand}"
                                                   CommandParameter="{Binding Source={x:Reference ItemGrid}, Path=BindingContext}"/>
                            </Grid.Behaviors>
                            <Label Grid.Column="0"
                                   Text="{Binding Category.Name, Converter={StaticResource CategoryToIconConverter}}"
                                   FontSize="18"
                                   VerticalOptions="Center"
                                   Margin="5,0,8,0"/>
                            <Grid Grid.Column="1"
                                  RowDefinitions="Auto,Auto"  
                                  ColumnDefinitions="Auto,*"  
                                  ColumnSpacing="5"
                                  RowSpacing="2"
                                  Margin="12,0,0,0"
                                  VerticalOptions="Center">
                                <Label Grid.Row="0"
                                       Grid.Column="0"
                                       Text="{Binding Priority, Converter={StaticResource PriorityToIconConverter}}"
                                       TextColor="Red"
                                       FontSize="16"
                                       IsVisible="{Binding HasPriority}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Row="0"
                                       Grid.Column="1"
                                       Text="{Binding Name}"
                                       LineBreakMode="WordWrap"
                                       MaxLines="2"
                                       TextColor="Black"
                                       FontSize="16"
                                       TextDecorations="{Binding IsPurchased, Converter={StaticResource StrikeThroughIfPurchasedConverter}}"/>
                                
                                <Label Grid.Row="1" 
                                       Grid.Column="1"
                                       FontSize="14"
                                       TextColor="{StaticResource OnSurfaceVariant}"
                                       IsVisible="{Binding Quantity, Converter={StaticResource NullOrEmptyToBoolConverter}}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="Qty: {0}{1}">
                                            <Binding Path="Quantity" />
                                            <Binding Path="Unit" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </Grid>
                        <Frame Grid.Column="2"
                                BackgroundColor="Transparent"
                                BorderColor="Transparent"
                                WidthRequest="40"
                                HeightRequest="40"
                                CornerRadius="20"
                                Padding="0"
                                HasShadow="False"
                                IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsNormalMode}">
                            <Label Text="✏️" 
                                       FontSize="14" 
                                       TextColor="#2196F3"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditItemCommand}"
                                                      CommandParameter="{Binding}"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                        <Frame Grid.Column="3"
                                   BackgroundColor="Transparent"
                                   BorderColor="Transparent"
                                   WidthRequest="40"
                                   HeightRequest="40"
                                   CornerRadius="20"
                                   Padding="0"
                                   HasShadow="False"
                                   IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsNormalMode}">
                            <Label Text="🗑️" 
                                       FontSize="14" 
                                       TextColor="#F44336"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteItemCommand}"
                                                          CommandParameter="{Binding}"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                    </Grid>
                </Border>
            </DataTemplate>
            <DataTemplate x:Key="ExpandableHeaderTemplate" x:DataType="model:ShoppingItemsGroup">
                <Border BackgroundColor="{StaticResource SurfaceVariant}" 
                        Padding="16,12"
                        StrokeShape="RoundRectangle 12">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.TogglePurchasedGroupCommand}"
                                              CommandParameter="{Binding}" />
                    </Border.GestureRecognizers>
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="{Binding Title}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{StaticResource OnSurfaceVariant}"
                               VerticalOptions="Center" />

                        <Label Grid.Column="1"
                               FontSize="18"
                               TextColor="{StaticResource OnSurfaceVariant}"
                               Text="{Binding IsExpanded, Converter={StaticResource BoolToExpandIconConverter}}" />
                    </Grid>
                </Border>
            </DataTemplate>
            <DataTemplate x:Key="EmptyHeaderTemplate">
                <ContentView HeightRequest="0" IsVisible="False" />
            </DataTemplate>
        </ResourceDictionary>
    </ContentPage.Resources>
</ContentPage>